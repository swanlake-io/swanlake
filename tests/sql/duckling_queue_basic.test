# name: tests/sql/duckling_queue_basic.test
# description: end-to-end duckling_queue staging and flush
# group: [sql]

require ducklake

statement ok
ATTACH 'ducklake:postgres:dbname=swanlake_test' AS swanlake (DATA_PATH '__TEST_DIR__/swanlake_files', OVERRIDE_DATA_PATH true)

statement ok
DROP TABLE IF EXISTS swanlake.queue_sink;

statement ok
CREATE TABLE swanlake.queue_sink(i INTEGER);

statement ok
INSERT INTO duckling_queue.queue_sink SELECT 1 AS i UNION ALL SELECT 2;

query I
SELECT count(*) >= 1
FROM glob('__TEST_DIR__/duckling_queue/table-*/*.arrow')
----
true

query I
SELECT COUNT(*) FROM swanlake.queue_sink
----
0

statement ok
PRAGMA duckling_queue.flush;

query I
SELECT COUNT(*) FROM swanlake.queue_sink
----
2

query I
SELECT count(*) = 0
FROM glob('__TEST_DIR__/duckling_queue/table-*/*.arrow')
----
true

statement error
SELECT COUNT(*) FROM duckling_queue.queue_sink;

statement ok
INSERT INTO duckling_queue.queue_sink SELECT 3 AS i UNION ALL SELECT 4;

statement ok
PRAGMA duckling_queue.flush;

query I
SELECT * FROM swanlake.queue_sink ORDER BY i
----
1
2
3
4

statement ok
PRAGMA duckling_queue.cleanup;

statement ok
DROP TABLE IF EXISTS swanlake.queue_sink;
