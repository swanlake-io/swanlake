# name: tests/sql/duckling_queue_basic.test
# description: end-to-end duckling_queue staging and flush
# group: [sql]

require ducklake

statement ok
DROP TABLE IF EXISTS swanlake.queue_sink;

statement ok
CREATE TABLE swanlake.queue_sink(i INTEGER);

statement ok
INSERT INTO duckling_queue.queue_sink SELECT 1 AS i UNION ALL SELECT 2;

query I
SELECT count(*) >= 1
FROM glob('__TEST_DIR__/duckling_queue/table-*/*.parquet')
----
true

query I
SELECT COUNT(*) FROM swanlake.queue_sink
----
0

statement ok
PRAGMA duckling_queue.flush;

query I
SELECT COUNT(*) FROM swanlake.queue_sink
----
2

query I
SELECT count(*) = 0
FROM glob('__TEST_DIR__/duckling_queue/table-*/*.parquet')
----
true

statement error
SELECT COUNT(*) FROM duckling_queue.queue_sink;

statement ok
INSERT INTO duckling_queue.queue_sink SELECT 3 AS i UNION ALL SELECT 4;

statement ok
PRAGMA duckling_queue.flush;

query I
SELECT * FROM swanlake.queue_sink ORDER BY i
----
1
2
3
4

statement error
SELECT 1 FROM duckling_queue.queue_sink WHERE i > 0;

statement error
DELETE FROM duckling_queue.queue_sink WHERE i > 0;

statement error
UPDATE duckling_queue.queue_sink SET i = 10 WHERE i = 1;

statement ok
DROP TABLE IF EXISTS swanlake.queue_sink;
