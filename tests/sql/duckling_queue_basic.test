# name: tests/sql/duckling_queue_basic.test
# description: end-to-end duckling_queue staging and flush
# group: [sql]

require ducklake

statement ok
ATTACH 'ducklake:postgres:dbname=swanlake_test' AS swanlake (DATA_PATH '__TEST_DIR__/swanlake_files', OVERRIDE_DATA_PATH true)

statement ok
DROP TABLE IF EXISTS swanlake.queue_sink;

statement ok
CREATE TABLE duckling_queue.queue_sink AS SELECT 1 AS i UNION ALL SELECT 2;

query I
SELECT COUNT(*) FROM duckling_queue.queue_sink
----
2

statement ok
PRAGMA duckling_queue.flush;

query I
SELECT COUNT(*) FROM swanlake.queue_sink
----
2

statement error
SELECT COUNT(*) FROM duckling_queue.queue_sink;

query I
SELECT count(*) >= 1
FROM glob('__TEST_DIR__/duckling_queue/flushed/*.db')
----
true

statement ok
CREATE TABLE duckling_queue.queue_sink AS SELECT 3 AS i UNION ALL SELECT 4;

statement ok
PRAGMA duckling_queue.flush;

query I
SELECT * FROM swanlake.queue_sink ORDER BY i
----
1
2
3
4

statement ok
PRAGMA duckling_queue.cleanup;
