# name: tests/sql/duckling_queue_basic.test
# description: end-to-end duckling_queue staging and flush
# group: [sql]

require ducklake

statement ok
ATTACH 'ducklake:__TEST_DIR__/swanlake.db' AS swanlake (DATA_PATH '__TEST_DIR__/swanlake_files')

statement ok
DROP TABLE IF EXISTS swanlake.queue_sink;

statement ok
CREATE TABLE duckling_queue.queue_sink AS SELECT 1 AS i UNION ALL SELECT 2;

query I
SELECT COUNT(*) FROM duckling_queue.queue_sink
----
2

statement ok
PRAGMA duckling_queue.flush;

query I
SELECT COUNT(*) FROM swanlake.queue_sink
----
2

statement error
SELECT COUNT(*) FROM duckling_queue.queue_sink;

statement ok
CREATE TEMP TABLE dq_flushed_files AS
SELECT path
FROM glob('__TEST_DIR__/duckling_queue/flushed/*.db')
ORDER BY path DESC
LIMIT 1;

statement ok
ATTACH (SELECT path FROM dq_flushed_files LIMIT 1) AS dq_flushed (READ_ONLY TRUE);

query I
SELECT COUNT(*) FROM dq_flushed."__dq_flushed_queue_sink"
----
2

statement ok
DETACH dq_flushed;

statement ok
DROP TABLE dq_flushed_files;

statement ok
CREATE TABLE duckling_queue.queue_sink AS SELECT 3 AS i UNION ALL SELECT 4;

statement ok
PRAGMA duckling_queue.flush;

query I
SELECT * FROM swanlake.queue_sink ORDER BY i
----
1
2
3
4

statement ok
PRAGMA duckling_queue.cleanup;
